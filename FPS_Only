-- ðŸ”¥ HTP Ultimate FPS Hub V9.0 ESP PERSISTENT by Ajani Ngawi ðŸ”¥ðŸ±
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")
local TS = game:GetService("TweenService")
local WS = game:GetService("Workspace")
local player = Players.LocalPlayer
local camera = WS.CurrentCamera

local gui = Instance.new("ScreenGui")
gui.Name = "HTP_Ultimate_V9_ESP"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

-- [GUI CODE SAMA SEPERTI V8 - NEON ANIMASI, SPEED/JUMP/CAMERA SECTION - SKIP UNTUK SINGKAT, COPY DARI V8]
-- ... (Paste seluruh GUI code dari respons V8 di atas, termasuk toggleBtn, main frame, sections speed/jump/cam/spin/aimbot)

-- =============================================
-- ESP PERSISTENT SECTION UPGRADE ðŸ”¥ðŸ±
-- =============================================
local espSection = Instance.new("Frame")
espSection.Size = UDim2.new(1,-16,0,100)
espSection.BackgroundTransparency = 1
espSection.Parent = scroll  -- scroll dari GUI V8

local espTitle = Instance.new("TextLabel")
espTitle.Size = UDim2.new(1,0,0,28)
espTitle.BackgroundTransparency = 1
espTitle.Text = "ðŸ‘ï¸ ESP Persistent (All Join)"
espTitle.TextColor3 = Color3.fromRGB(255, 100, 255)
espTitle.Font = Enum.Font.GothamBold
espTitle.TextSize = 16
espTitle.TextXAlignment = Enum.TextXAlignment.Left
espTitle.Parent = espSection

local espToggle = Instance.new("TextButton")
espToggle.Size = UDim2.new(0.6,0,0,38)
espToggle.Position = UDim2.new(0,0,0,35)
espToggle.BackgroundColor3 = Color3.fromRGB(100,100,120)
espToggle.Text = "ESP All Players: OFF"
espToggle.TextColor3 = Color3.new(1,1,1)
espToggle.Font = Enum.Font.GothamSemibold
espToggle.TextSize = 15
espToggle.Parent = espSection

local healthBarToggle = Instance.new("TextButton")
healthBarToggle.Size = UDim2.new(0.38,0,0,38)
healthBarToggle.Position = UDim2.new(0.62,0,0,35)
healthBarToggle.BackgroundColor3 = Color3.fromRGB(100,150,255)
healthBarToggle.Text = "Health Bar: OFF"
healthBarToggle.TextColor3 = Color3.new(1,1,1)
healthBarToggle.Font = Enum.Font.GothamSemibold
healthBarToggle.TextSize = 13
healthBarToggle.Parent = espSection

-- ESP STATE
state.esp = false
local showHealthBar = false
local espObjects = {}  -- player.UserId -> {box, name, line, healthbar}
local espConnection

-- CREATE ESP FOR ONE PLAYER
local function createESP(plr)
    if plr == player or not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then return end
    
    local char = plr.Character
    local hrp = char.HumanoidRootPart
    local head = char:FindFirstChild("Head")
    if not head then return end
    
    -- BOX
    local box = Drawing.new("Quad")
    box.Thickness = 2
    box.Color = Color3.fromRGB(0, 255, 0)  -- Green alive
    box.Transparency = 1
    box.Filled = false
    
    -- NAME + DIST
    local nameLabel = Drawing.new("Text")
    nameLabel.Size = 16
    nameLabel.Center = true
    nameLabel.Outline = true
    nameLabel.Color = Color3.fromRGB(255, 255, 255)
    nameLabel.Font = 2
    
    -- LINE TO CENTER
    local line = Drawing.new("Line")
    line.Thickness = 2
    line.Color = Color3.fromRGB(255, 0, 0)
    line.Transparency = 1
    
    -- HEALTH BAR (Optional)
    local healthBg = Drawing.new("Quad")
    healthBg.Thickness = 3
    healthBg.Color = Color3.fromRGB(0,0,0)
    healthBg.Filled = true
    healthBg.Transparency = 0.5
    
    local healthFg = Drawing.new("Quad")
    healthFg.Thickness = 1
    healthFg.Color = Color3.fromRGB(0, 255, 0)
    healthFg.Filled = true
    healthFg.Transparency = 0.7
    
    espObjects[plr.UserId] = {box = box, name = nameLabel, line = line, healthBg = healthBg, healthFg = healthFg, char = char, plr = plr}
end

-- UPDATE ESP LOOP (PERSISTENT ALL)
local function updateESP()
    for userId, espData in pairs(espObjects) do
        local plr = espData.plr
        if plr and plr.Parent and espData.char and espData.char.Parent then
            local char = espData.char
            local hum = char:FindFirstChildOfClass("Humanoid")
            local hrp = char:FindFirstChild("HumanoidRootPart")
            local head = char:FindFirstChild("Head")
            
            if hrp and head and hum and hum.Health > 0 then  -- Alive
                local screenPos, onScreen = camera:WorldToViewportPoint(hrp.Position)
                local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0,0.5,0))
                local legPos = camera:WorldToViewportPoint(hrp.Position - Vector3.new(0,3,0))
                
                if onScreen then
                    -- BOX
                    local size = (headPos - legPos).Magnitude
                    espData.box.PointA = Vector2.new(screenPos.X - size/2, headPos.Y)
                    espData.box.PointB = Vector2.new(screenPos.X + size/2, headPos.Y)
                    espData.box.PointC = Vector2.new(screenPos.X + size/2, legPos.Y)
                    espData.box.PointD = Vector2.new(screenPos.X - size/2, legPos.Y)
                    espData.box.Visible = true
                    espData.box.Color = hum.Health < 30 and Color3.fromRGB(255,0,0) or Color3.fromRGB(0,255,0)  -- Red low HP
                    
                    -- NAME + DIST
                    local dist = (hrp.Position - getHRP().Position).Magnitude
                    espData.name.Text = plr.Name .. "\n[" .. math.floor(dist) .. "]"
                    espData.name.Position = Vector2.new(screenPos.X, headPos.Y - 30)
                    espData.name.Visible = true
                    
                    -- LINE
                    espData.line.From = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
                    espData.line.To = Vector2.new(screenPos.X, screenPos.Y)
                    espData.line.Visible = true
                    
                    -- HEALTH BAR
                    if showHealthBar then
                        local hpPercent = hum.Health / hum.MaxHealth
                        local barHeight = size * 0.6
                        local barWidth = 4
                        local barPosY = legPos.Y + (size - barHeight)/2
                        
                        espData.healthBg.Size = Vector2.new(barWidth, barHeight)
                        espData.healthBg.Position = Vector2.new(screenPos.X + size/2 + 2, barPosY)
                        espData.healthBg.Visible = true
                        
                        espData.healthFg.Size = Vector2.new(barWidth * hpPercent, barHeight)
                        espData.healthFg.Position = Vector2.new(screenPos.X + size/2 + 2, barPosY + barHeight * (1 - hpPercent))
                        espData.healthFg.Color = Color3.fromRGB(255 * (1 - hpPercent), 255 * hpPercent, 0)
                        espData.healthFg.Visible = true
                    end
                else
                    for _, obj in pairs({espData.box, espData.name, espData.line, espData.healthBg, espData.healthFg}) do
                        obj.Visible = false
                    end
                end
            else  -- Dead/Hidden
                for _, obj in pairs({espData.box, espData.name, espData.line, espData.healthBg, espData.healthFg}) do
                    obj.Visible = false
                end
            end
        end
    end
end

-- TOGGLE ESP
espToggle.MouseButton1Click:Connect(function()
    state.esp = not state.esp
    espToggle.Text = "ESP All Players: " .. (state.esp and "ON" or "OFF")
    espToggle.BackgroundColor3 = state.esp and Color3.fromRGB(255,100,255) or Color3.fromRGB(100,100,120)
    
    if state.esp then
        -- Init all current players
        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= player then
                createESP(plr)
            end
        end
        espConnection = RS.RenderStepped:Connect(updateESP)
        addConnection("esp", espConnection)
    else
        -- Cleanup all
        for _, espData in pairs(espObjects) do
            for _, obj in pairs({espData.box, espData.name, espData.line, espData.healthBg, espData.healthFg}) do
                obj:Remove()
            end
        end
        espObjects = {}
        if espConnection then espConnection:Disconnect() end
    end
end)

-- HEALTH BAR TOGGLE
healthBarToggle.MouseButton1Click:Connect(function()
    showHealthBar = not showHealthBar
    healthBarToggle.Text = "Health Bar: " .. (showHealthBar and "ON" or "OFF")
    healthBarToggle.BackgroundColor3 = showHealthBar and Color3.fromRGB(255,150,100) or Color3.fromRGB(100,150,255)
end)

-- PERSISTENT HANDLERS: Join/Leave/Respawn
Players.PlayerAdded:Connect(function(plr)
    if state.esp and plr ~= player then
        plr.CharacterAdded:Connect(function()
            wait(0.5)  -- Wait load
            createESP(plr)
        end)
    end
end)

Players.PlayerRemoving:Connect(function(plr)
    if espObjects[plr.UserId] then
        for _, obj in pairs(espObjects[plr.UserId]) do
            if obj then obj:Remove() end
        end
        espObjects[plr.UserId] = nil
    end
end)

-- Auto recreate on respawn for existing
for _, plr in pairs(Players:GetPlayers()) do
    if plr ~= player then
        plr.CharacterAdded:Connect(function()
            if state.esp then
                wait(0.5)
                createESP(plr)
            end
        end)
    end
end

-- [HOVER TWEENS UNTUK ESP TOGGLES - SAMA V8]
espToggle.MouseEnter:Connect(function() TS:Create(espToggle, tweenHover, {Size = UDim2.new(0.62,10,0,45)}):Play() end)
espToggle.MouseLeave:Connect(function() TS:Create(espToggle, tweenHover, {Size = UDim2.new(0.6,0,0,38)}):Play() end)

-- [SELESAI ESP - PASTE GUI V8 DI ATAS INI + AIMBOT/SPIN DARI ORIGINAL]

print("ðŸ”¥ HTP V9.0 ESP PERSISTENT Loaded! All join = ESP forever! Ajani Ngawi OP ðŸ±")
